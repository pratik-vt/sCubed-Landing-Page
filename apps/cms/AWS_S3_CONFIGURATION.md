# AWS S3 Upload Configuration for Strapi CMS

This document describes how to configure AWS S3 file uploads for the Strapi CMS backend using IAM roles for authentication and signed URLs for private bucket access.

## Overview

The CMS is configured to use the `@strapi/provider-upload-aws-s3` plugin for handling file uploads to Amazon S3. This setup uses IAM roles for authentication instead of access keys, which is more secure and follows AWS best practices. For private S3 buckets, signed URLs are automatically generated to provide secure, time-limited access to uploaded files.

## Package Installation

The required package has been installed:

```bash
npm install @strapi/provider-upload-aws-s3
```

## Configuration

### Plugin Configuration (`config/plugins.ts`)

```typescript
export default ({ env }) => ({
  upload: {
    config: {
      provider: 'aws-s3',
      providerOptions: {
        // Use IAM roles instead of access keys for authentication
        // This is more secure and follows AWS best practices
        s3Options: {
          // The AWS SDK will automatically use IAM roles if available
          // No need to specify accessKeyId or secretAccessKey
          region: env('AWS_REGION'),
          // S3 bucket parameters for private bucket with signed URLs
          params: {
            Bucket: env('AWS_S3_BUCKET'),
            // Set ACL to 'private' for private bucket with signed URLs
            ACL: 'private',
            // Signed URL expiration time in seconds (default: 15 minutes)
            signedUrlExpires: env.int('AWS_SIGNED_URL_EXPIRES', 15 * 60),
          },
        },
      },
      actionOptions: {
        upload: {
          // Optional: Add metadata to uploaded files
        },
        uploadStream: {
          // Optional: Configure streaming uploads
        },
        delete: {
          // Optional: Configure delete behavior
        },
      },
      // Responsive image breakpoints
      breakpoints: {
        xlarge: 1920,
        large: 1000,
        medium: 750,
        small: 500,
        xsmall: 64,
      },
    },
  },
});
```

### Environment Variables

Add these environment variables to your deployment configuration:

```bash
# Required AWS S3 Configuration
AWS_S3_BUCKET=your-s3-bucket-name
AWS_REGION=us-east-1

# Optional Configuration
AWS_SIGNED_URL_EXPIRES=900                       # URL expiration in seconds (15 minutes)
```

**Note:** 
- No AWS access keys (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY) are required when using IAM roles.
- `baseUrl` and `rootPath` options are not used with private buckets since signed URLs are generated dynamically.

## Signed URLs for Private Buckets

### How Signed URLs Work

When your S3 bucket is configured as private (ACL: 'private'), Strapi automatically generates signed URLs for uploaded files. These URLs:

- **Are temporary**: Valid only for the specified duration (default: 15 minutes)
- **Are secure**: Include encrypted signatures that prevent unauthorized access
- **Are automatic**: Generated by Strapi when files are requested from the Content Manager
- **Are not public**: Direct S3 URLs will return "Access Denied" errors

### Signed URL Configuration

The signed URL behavior is controlled by these parameters in the `s3Options.params` object:

```typescript
params: {
  Bucket: env('AWS_S3_BUCKET'),
  ACL: 'private',                                    // Enables signed URLs
  signedUrlExpires: env.int('AWS_SIGNED_URL_EXPIRES', 15 * 60), // 15 minutes
},
```

### URL Expiration Settings

| Time Period | Seconds | Use Case |
|-------------|---------|----------|
| 5 minutes   | 300     | High security, short-term access |
| 15 minutes  | 900     | Default, balanced security/usability |
| 1 hour      | 3600    | Extended access for large files |
| 24 hours    | 86400   | Long-term access (not recommended) |

**Recommendation**: Keep expiration times as short as possible while meeting your application's needs.

## Public vs Private Bucket Configuration

### Private Bucket (Current Configuration)
- **ACL**: `'private'`
- **Access**: Via signed URLs only
- **Use Case**: Secure file storage, controlled access
- **URLs**: Temporary, signed URLs with expiration
- **Options**: `baseUrl` and `rootPath` are not applicable

### Public Bucket (Alternative)
- **ACL**: `'public-read'`
- **Access**: Direct public URLs
- **Use Case**: Public assets, CDN delivery
- **URLs**: Permanent, direct S3 URLs
- **Options**: `baseUrl` and `rootPath` can be used for custom domains/CDN

## AWS Infrastructure Setup

### 1. S3 Bucket Configuration

Create an S3 bucket with the following settings:

- **Bucket Name**: Set to match your `AWS_S3_BUCKET` environment variable
- **Region**: Set to match your `AWS_REGION` environment variable
- **Public Access**: **Block all public access** (required for private bucket)
- **Versioning**: Enable if you want file version history
- **Encryption**: Enable server-side encryption (recommended)

### 2. IAM Role Configuration

Create an IAM role with the following permissions policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::your-s3-bucket-name/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::your-s3-bucket-name"
    }
  ]
}
```

**Important**: The `s3:GetObject` permission is required for generating signed URLs.

### 3. Attach IAM Role to Infrastructure

- **EC2 Instance**: Attach the IAM role to your EC2 instance
- **ECS Task**: Attach the IAM role to your ECS task definition
- **Lambda Function**: Attach the IAM role to your Lambda function
- **Kubernetes**: Use IAM roles for service accounts (IRSA)

## Security Benefits

Using IAM roles with signed URLs for private buckets provides several security advantages:

1. **No Long-term Credentials**: No need to manage static access keys
2. **Automatic Credential Rotation**: AWS automatically handles credential rotation
3. **Time-Limited Access**: Files are only accessible for the specified duration
4. **Secure URLs**: Encrypted signatures prevent URL tampering
5. **Private by Default**: Files are not publicly accessible
6. **Audit Trail**: Better CloudTrail logging and monitoring

## Content API Behavior

**Important**: For security reasons, the Strapi REST/GraphQL APIs will **not** provide signed URLs in their responses. The APIs will return the file path only. Signed URLs are only generated and used within the Strapi admin panel (Content Manager).

If you need signed URLs in your frontend application, you should implement your own endpoint that generates them server-side using AWS SDK.

## Security Middleware Configuration

Due to the default settings in the Strapi Security Middleware, you'll need to modify the `contentSecurityPolicy` settings to properly see thumbnail previews in the Media Library:

```javascript
// config/middlewares.js
module.exports = [
  // ...
  {
    name: 'strapi::security',
    config: {
      contentSecurityPolicy: {
        useDefaults: true,
        directives: {
          'connect-src': ["'self'", 'https:'],
          'img-src': [
            "'self'",
            'data:',
            'blob:',
            'market-assets.strapi.io',
            // Add your S3 bucket domain for signed URLs
            '*.amazonaws.com',
          ],
          'media-src': [
            "'self'",
            'data:',
            'blob:',
            'market-assets.strapi.io',
            // Add your S3 bucket domain for signed URLs
            '*.amazonaws.com',
          ],
          upgradeInsecureRequests: null,
        },
      },
    },
  },
  // ...
];
```

## Deployment Considerations

### Development Environment

For local development, you can:

1. Use AWS CLI profiles with temporary credentials
2. Use AWS SSO
3. Use IAM roles if running on AWS infrastructure

### Production Environment

Ensure your deployment platform supports IAM roles:

- **AWS EC2**: Native IAM role support
- **AWS ECS/Fargate**: Task role support
- **AWS Lambda**: Execution role support
- **Kubernetes on AWS**: Use IAM roles for service accounts (IRSA)

## Testing the Configuration

1. Start your Strapi application
2. Access the admin panel
3. Try uploading a file through the media library
4. Verify the file is stored in your S3 bucket with private ACL
5. Check that the file preview in Strapi uses a signed URL (you'll see URL parameters like `X-Amz-Algorithm`, `X-Amz-Credential`, etc.)
6. Verify that accessing the direct S3 URL without parameters returns "Access Denied"

## Troubleshooting

### Common Issues

1. **Permission Denied**: Verify IAM role has correct S3 permissions including `s3:GetObject`
2. **Bucket Not Found**: Check AWS_S3_BUCKET environment variable
3. **Region Mismatch**: Ensure AWS_REGION matches your S3 bucket region
4. **Role Not Attached**: Verify IAM role is properly attached to your infrastructure
5. **Signed URLs Not Working**: Ensure ACL is set to 'private' and `s3:GetObject` permission is granted
6. **URL Expired**: Check if signed URL expiration time is appropriate for your use case

### Debugging

Enable AWS SDK debugging by setting:

```bash
AWS_SDK_LOAD_CONFIG=1
AWS_SDK_JS_SUPPRESS_MAINTENANCE_MODE_MESSAGE=1
```

## Migration from Public to Private Bucket

If migrating from a public bucket to private with signed URLs:

1. Update bucket permissions to block public access
2. Update IAM role to include `s3:GetObject` permission
3. Set ACL to 'private' in the configuration
4. Test file upload and access functionality
5. Update any frontend code that relies on direct S3 URLs

## Signed URL Implementation Details

The AWS S3 provider automatically detects when a bucket is private (ACL: 'private') and:

1. **Upload**: Files are uploaded with private ACL
2. **Storage**: File URLs are stored as relative paths in Strapi database
3. **Access**: When files are requested in the admin panel, signed URLs are generated on-demand
4. **Expiration**: URLs automatically expire after the specified time

## References

- [Strapi Upload Plugin Documentation](https://docs.strapi.io/cms/configurations/plugins#upload)
- [AWS S3 Upload Provider Documentation](https://www.npmjs.com/package/@strapi/provider-upload-aws-s3)
- [AWS IAM Roles Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [AWS S3 Signed URLs Documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/PresignedUrlUploadObject.html)
- [Strapi Preview Mode Implementation](https://strapi.io/blog/implementing-previews-with-next-applications-using-a-strapi-backend) 